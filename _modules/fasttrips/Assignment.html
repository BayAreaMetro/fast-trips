

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fasttrips.Assignment &mdash; fasttrips 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="fasttrips 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> fasttrips
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Assignment.html">fasttrips.Assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Error.html">fasttrips.Error</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.FastTrips.html">fasttrips.FastTrips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.FastTripsLogger.html">fasttrips.FastTripsLogger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Passenger.html">fasttrips.Passenger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.PathSet.html">fasttrips.PathSet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Performance.html">fasttrips.Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Route.html">fasttrips.Route</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Run.html">fasttrips.Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Stop.html">fasttrips.Stop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.TAZ.html">fasttrips.TAZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Transfer.html">fasttrips.Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Trip.html">fasttrips.Trip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Util.html">fasttrips.Util</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fasttrips_c_extension.html">fasttrips C++ Extension</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">fasttrips</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>fasttrips.Assignment</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for fasttrips.Assignment</h1><div class="highlight"><pre>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2015-2017 Contributing Entities&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s">    you may not use this file except in compliance with the License.</span>
<span class="s">    You may obtain a copy of the License at</span>

<span class="s">        http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="s">    Unless required by applicable law or agreed to in writing, software</span>
<span class="s">    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s">    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s">    See the License for the specific language governing permissions and</span>
<span class="s">    limitations under the License.</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span><span class="o">,</span><span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">collections</span><span class="o">,</span><span class="nn">datetime</span><span class="o">,</span><span class="nn">math</span><span class="o">,</span><span class="nn">multiprocessing</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">random</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span><span class="o">,</span><span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">_fasttrips</span>

<span class="kn">from</span> <span class="nn">.Error</span>       <span class="kn">import</span> <span class="n">ConfigurationError</span>
<span class="kn">from</span> <span class="nn">.Logger</span>      <span class="kn">import</span> <span class="n">FastTripsLogger</span><span class="p">,</span> <span class="n">setupLogging</span>
<span class="kn">from</span> <span class="nn">.Passenger</span>   <span class="kn">import</span> <span class="n">Passenger</span>
<span class="kn">from</span> <span class="nn">.PathSet</span>     <span class="kn">import</span> <span class="n">PathSet</span>
<span class="kn">from</span> <span class="nn">.Performance</span> <span class="kn">import</span> <span class="n">Performance</span>
<span class="kn">from</span> <span class="nn">.Stop</span>        <span class="kn">import</span> <span class="n">Stop</span>
<span class="kn">from</span> <span class="nn">.TAZ</span>         <span class="kn">import</span> <span class="n">TAZ</span>
<span class="kn">from</span> <span class="nn">.Transfer</span>    <span class="kn">import</span> <span class="n">Transfer</span>
<span class="kn">from</span> <span class="nn">.Trip</span>        <span class="kn">import</span> <span class="n">Trip</span>
<span class="kn">from</span> <span class="nn">.Util</span>        <span class="kn">import</span> <span class="n">Util</span>

<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assignment class.  Documentation forthcoming.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#: Configuration file for fasttrips</span>
    <span class="n">CONFIGURATION_FILE</span>              <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Configuration functions</span>
    <span class="n">CONFIGURATION_FUNCTIONS_FILE</span>    <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Output copy of the configuration file in case anything got overridden</span>
    <span class="c">#: (Hmm naming conventions are a bit awkward here)</span>
    <span class="n">CONFIGURATION_OUTPUT_FILE</span>       <span class="o">=</span> <span class="s">&#39;ft_output_config.txt&#39;</span>

    <span class="c">#: Configuration: Input network directory</span>
    <span class="n">INPUT_NETWORK_DIR</span>               <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Configuration: Input demand directory</span>
    <span class="n">INPUT_DEMAND_DIR</span>                <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Configuration: Pathweight parameters</span>
    <span class="n">INPUT_WEIGHTS</span>                   <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Configuration: Run Configuration</span>
    <span class="n">OUTPUT_DIR</span>                      <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: Maximum number of iterations to remove capacity violations. When</span>
    <span class="c">#: the transit system is not crowded or when capacity constraint is</span>
    <span class="c">#: relaxed the model will terminate after the first iteration</span>
    <span class="n">MAX_ITERATIONS</span>                  <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Find paths deterministically, using shortest path search based on travel time.</span>
    <span class="n">PATHFINDING_TYPE_DETERMINISTIC</span>  <span class="o">=</span> <span class="s">&#39;deterministic&#39;</span>
    <span class="c">#: Find paths stochastically using trip-based hyperpath</span>
    <span class="n">PATHFINDING_TYPE_STOCHASTIC</span>     <span class="o">=</span> <span class="s">&#39;stochastic&#39;</span>
    <span class="c">#: Don&#39;t find paths; read :py:attr:`Passenger.PF_PATHS_CSV` and :py:attr:`Passenger.PF_LINKS_CSV`.</span>
    <span class="n">PATHFINDING_TYPE_READ_FILE</span>      <span class="o">=</span> <span class="s">&#39;file&#39;</span>
    <span class="c">#: Configuration: Pathfinding Type.  Should be one of `Deterministic`, `Stochastic` or `File`</span>
    <span class="n">PATHFINDING_TYPE</span>                <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: Do simulation? It should be True for iterative assignment. In a one shot</span>
    <span class="c">#: assignment with simulation flag off, the passengers are assigned to</span>
    <span class="c">#: paths but are not loaded to the network.  Boolean.</span>
    <span class="n">SIMULATION</span>                      <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: Passenger trajectory output flag. Passengers&#39; path and time will be</span>
    <span class="c">#: reported if this flag is on. Note that the simulation flag should be on for</span>
    <span class="c">#: passengers&#39; time.  Boolean.</span>
    <span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span>   <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: If true, outputs pathset every simulation iteration.  If false,</span>
    <span class="c">#: outputs pathset every path-finding iteration.</span>
    <span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span>     <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: Path time-window. This is the time in which the paths are generated.</span>
    <span class="c">#: E.g. with a typical 30 min window, any path within 30 min of the</span>
    <span class="c">#: departure time will be checked.  A :py:class:`datetime.timedelta` instance.</span>
    <span class="n">TIME_WINDOW</span>                     <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: Create skims flag. This is specific to the travel demand models</span>
    <span class="c">#: (not working in this version). Boolean.</span>
    <span class="n">CREATE_SKIMS</span>                    <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: Beginning of the time period for which the skim is required.</span>
    <span class="c">#:  (specify as &#39;HH:MM&#39;). A :py:class:`datetime.datetime` instance.</span>
    <span class="n">SKIM_START_TIME</span>                 <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Configuration: End of the time period for which the skim is required</span>
    <span class="c">#: (specify as &#39;HH:MM&#39;). A :py:class:`datetime.datetime` instance.</span>
    <span class="n">SKIM_END_TIME</span>                   <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Route choice configuration: Max number of paths in a pathset.</span>
    <span class="c">#: Used in conjuntion with :py:attr:`Assignment.MIN_PATH_PROBABILITY`</span>
    <span class="n">MAX_NUM_PATHS</span>                   <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Route choice configuration: Minimum path probability for the path to be used.</span>
    <span class="c">#: Used in conjucntion with :py:attr:`Assignment.MAX_NUM_PATHS`, so it only</span>
    <span class="c">#: kicks in if that is specified AND we hit it, then we start dropping using</span>
    <span class="c">#: this threshhold.</span>
    <span class="n">MIN_PATH_PROBABILITY</span>            <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Route choice configuration: Dispersion parameter in the logit function.</span>
    <span class="c">#: Higher values result in less stochasticity. Must be nonnegative. </span>
    <span class="c">#: If unknown use a value between 0.5 and 1. Float.</span>
    <span class="n">STOCH_DISPERSION</span>                <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: In path-finding, suppress trying to adjust fares using transfer fare rules.</span>
    <span class="c">#: This is for performance testing.</span>
    <span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: In path-enumeration, suppress trying to adjust fares using transfer fare rules.</span>
    <span class="c">#: This is for performance testing.</span>
    <span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span>    <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Route choice configuration: How many times max times should we process a stop</span>
    <span class="c">#: during labeling?  Use -1 to specify no max.  Int.</span>
    <span class="c">#: Setting this to a positive value may increase runtime but may decrease</span>
    <span class="c">#: pathset quality. (Todo: test/quantify this.)</span>
    <span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span>    <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Route choice configuration: How many stochastic paths will we generate</span>
    <span class="c">#: (not necessarily unique) to define a path choice set?  Int.</span>
    <span class="n">STOCH_PATHSET_SIZE</span>              <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Route choice configuration: Use vehicle capacity constraints. Boolean.</span>
    <span class="n">CAPACITY_CONSTRAINT</span>             <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Debug mode: only run trace passengers</span>
    <span class="n">DEBUG_TRACE_ONLY</span>                <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Debug mode: only run this number of trips, -1 to run all. Int.</span>
    <span class="n">DEBUG_NUM_TRIPS</span>                 <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c">#: Debug: include debug columns in output</span>
    <span class="n">DEBUG_OUTPUT_COLUMNS</span>            <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Fare zone symmetry. If True, will assume fare zone symmetry.  That is, if fare_id X is</span>
    <span class="c"># configured from origin zone A to destination zone B, and there is no fare configured</span>
    <span class="c"># from zone B to zone A, we&#39;ll assume that fare_id X also applies.</span>
    <span class="n">FARE_ZONE_SYMMETRY</span>              <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Skip these passengers</span>
    <span class="n">SKIP_PERSON_IDS</span>                 <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Trace these persons/person trips (a list of tuples)</span>
    <span class="n">TRACE_IDS</span>                       <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#: Prepend the route id to the trip id?  This is for readability in debugging, since</span>
    <span class="c">#: route IDs are typically more readable and trip ids are inscrutable</span>
    <span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span>     <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Number of processes to use for path finding (via :py:mod:`multiprocessing`)</span>
    <span class="c">#: Set to 1 to run everything in this process</span>
    <span class="c">#: Set to less than 1 to use the result of :py:func:`multiprocessing.cpu_count`</span>
    <span class="c">#: Set to positive integer greater than 1 to set a fixed number of processes</span>
    <span class="n">NUMBER_OF_PROCESSES</span>             <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Extra time so passengers don&#39;t get bumped (?). A :py:class:`datetime.timedelta` instance.</span>
    <span class="n">BUMP_BUFFER</span>                     <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: This is the only simulation state that exists across iterations</span>
    <span class="c">#: It&#39;s a dictionary of (trip_id, stop_id) -&gt; earliest time a bumped passenger started waiting</span>
    <span class="n">bump_wait</span>                       <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bump_wait_df</span>                    <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Simulation: bump one stop at a time (slower, more accurate)</span>
    <span class="c">#:</span>
    <span class="c">#: When addressing capacity constraints in simulation, we look at all the (trip, stop)-pairs</span>
    <span class="c">#: where the boards are not allowed since vehicle is over capacity.  The faster way to address</span>
    <span class="c">#: this is to bump all of those passengers, which means we call the assigned path bad and try</span>
    <span class="c">#: to reassign.</span>
    <span class="c">#:</span>
    <span class="c">#: However, this could over-bump passengers, because if a passenger rides multiple</span>
    <span class="c">#: crowded vehicles, then bumping her frees up space on other vehicles and so some other bumping</span>
    <span class="c">#: may not be necessary.  Thus, the more accurate (but slower) method is to bump passengers from</span>
    <span class="c">#: each (trip,stop) at a time, in order of the full vehicle arrival time, and then recalculate</span>
    <span class="c">#: loads, and iterate until we have no capacity issues.  Boolean.</span>
    <span class="n">BUMP_ONE_AT_A_TIME</span>              <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: MSA the results that affect the next iteration to avoid oscillation: boards, alights, overcap onboard at stops</span>
    <span class="n">MSA_RESULTS</span>                     <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Are we finding paths for everyone right now?  Or just un-arrived folks?</span>
    <span class="n">PATHFINDING_EVERYONE</span>            <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#: How many Simulation Iterations should we do before going back to path-finding?</span>
    <span class="n">MAX_SIMULATION_ITERS</span>            <span class="o">=</span> <span class="mi">10</span>

    <span class="c">#: Column names for simulation</span>
    <span class="n">SIM_COL_PAX_BOARD_TIME</span>          <span class="o">=</span> <span class="s">&#39;board_time&#39;</span>       <span class="c">#: Board time on the transit vehicle</span>
    <span class="n">SIM_COL_PAX_ALIGHT_TIME</span>         <span class="o">=</span> <span class="s">&#39;alight_time&#39;</span>      <span class="c">#: Alight time from the transit vehicle</span>

    <span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span>    <span class="o">=</span> <span class="s">&#39;alight_delay_min&#39;</span> <span class="c">#: Delay in alight_time from original pathfinding understanding of alight time</span>
    <span class="n">SIM_COL_PAX_A_TIME</span>              <span class="o">=</span> <span class="s">&#39;new_A_time&#39;</span>       <span class="c">#: Time of arrival at A</span>
    <span class="n">SIM_COL_PAX_B_TIME</span>              <span class="o">=</span> <span class="s">&#39;new_B_time&#39;</span>       <span class="c">#: Time of arrival at B</span>
    <span class="n">SIM_COL_PAX_LINK_TIME</span>           <span class="o">=</span> <span class="s">&#39;new_linktime&#39;</span>     <span class="c">#: Link time (SIM_COL_PAX_B_TIME - SIM_COL_PAX_A_TIME)</span>
    <span class="n">SIM_COL_PAX_WAIT_TIME</span>           <span class="o">=</span> <span class="s">&#39;new_waittime&#39;</span>     <span class="c">#: Wait time</span>
    <span class="n">SIM_COL_PAX_MISSED_XFER</span>         <span class="o">=</span> <span class="s">&#39;missed_xfer&#39;</span>      <span class="c">#: Is this link a missed transfer</span>

    <span class="n">SIM_COL_PAX_OVERCAP</span>             <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span>      <span class="c">#: </span>
    <span class="n">SIM_COL_PAX_OVERCAP_FRAC</span>        <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span> <span class="c">#: If board at an overcap stop, fraction of boards that are overcap</span>
    <span class="n">SIM_COL_PAX_BUMP_ITER</span>           <span class="o">=</span> <span class="s">&#39;bump_iter&#39;</span>
    <span class="n">SIM_COL_PAX_BOARD_STATE</span>         <span class="o">=</span> <span class="s">&#39;board_state&#39;</span>      <span class="c">#: NaN if not relevent, 1 if lucky enough to board at an at- or over-capacity stop, 0 if bumped.  Set by :py:meth:`Assignment.flag_bump_overcap_passengers`</span>
    <span class="n">SIM_COL_PAX_DISTANCE</span>            <span class="o">=</span> <span class="s">&quot;distance&quot;</span>         <span class="c">#: Link distance</span>
    <span class="n">SIM_COL_PAX_FARE</span>                <span class="o">=</span> <span class="s">&quot;fare&quot;</span>             <span class="c">#: Link fare in currency</span>
    <span class="n">SIM_COL_PAX_FARE_PERIOD</span>         <span class="o">=</span> <span class="s">&quot;fare_period&quot;</span>      <span class="c">#: Fare period id</span>
    <span class="n">SIM_COL_PAX_FREE_TRANSFER</span>       <span class="o">=</span> <span class="s">&quot;free_transfer&quot;</span>    <span class="c">#: Free transfer?  NaN, 0.0 or 1.0, only free based on `fare_attributes_ft.txt`</span>
    <span class="n">SIM_COL_PAX_COST</span>                <span class="o">=</span> <span class="s">&#39;sim_cost&#39;</span>         <span class="c">#: Link cost. (Cannot be `cost` because it collides with TAZ.DRIVE_ACCESS_COLUMN_COST)</span>
    <span class="n">SIM_COL_PAX_LNPS</span>                <span class="o">=</span> <span class="s">&#39;ln_PS&#39;</span>            <span class="c">#: log(PathSize)</span>
    <span class="n">SIM_COL_PAX_PROBABILITY</span>         <span class="o">=</span> <span class="s">&#39;probability&#39;</span>      <span class="c">#: Probability of this path</span>
    <span class="n">SIM_COL_PAX_LOGSUM</span>              <span class="o">=</span> <span class="s">&#39;logsum&#39;</span>           <span class="c">#: Logsum of all paths</span>

    <span class="c">#: Is this link/path a missed transfer?</span>
    <span class="c">#: Set in both pathset links and pathset paths, this is a 1 or 0</span>
    <span class="n">SIM_COL_MISSED_XFER</span>             <span class="o">=</span> <span class="s">&#39;missed_xfer&#39;</span>

    <span class="c">#: Values for :py:attr:`Assignment.SIM_COL_PAX_BOARD_STATE` column</span>
    <span class="n">BOARD_STATE_CATEGORICAL</span>    <span class="o">=</span> <span class="p">[</span> \
        <span class="s">&quot;board_easy&quot;</span><span class="p">,</span>       <span class="c">#: path chosen and no capacity problems</span>
        <span class="s">&quot;boarded&quot;</span><span class="p">,</span>          <span class="c">#: path chosen and lucky enough to board an at-capacity or over-capacity vehicle</span>
        <span class="s">&quot;bumped&quot;</span><span class="p">,</span>           <span class="c">#: path chosen but bumped due to capacity problems</span>
        <span class="s">&quot;bumped_othertrip&quot;</span><span class="p">,</span> <span class="c">#: path invalidated due to being bumped on another link of this person&#39;s trip</span>
        <span class="s">&quot;bumped_unchosen&quot;</span><span class="p">]</span>  <span class="c">#: path invalidated before ever chosen due to capacity problems</span>

    <span class="c">#: Chosen status for path</span>
    <span class="n">SIM_COL_PAX_CHOSEN</span>              <span class="o">=</span> <span class="s">&#39;chosen&#39;</span>
    <span class="c">#: categories for SIM_COL_PAX_CHOSEN</span>
    <span class="n">CHOSEN_NOT_CHOSEN_YET</span>           <span class="o">=</span> <span class="s">&quot;unchosen&quot;</span>
    <span class="n">CHOSEN_REJECTED</span>                 <span class="o">=</span> <span class="s">&quot;rejected&quot;</span>
    <span class="c">#: These will be ordered, so to select chosen, choose those &gt; CHOSEN_NOT_CHOSEN_YET</span>
    <span class="n">CHOSEN_CATEGORIES</span>               <span class="o">=</span> <span class="p">[</span><span class="n">CHOSEN_REJECTED</span><span class="p">,</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">]</span>

<div class="viewcode-block" id="Assignment.__init__"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This does nothing.  Assignment methods are static methods for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.read_functions"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.read_functions">[docs]</a>    <span class="k">def</span> <span class="nf">read_functions</span><span class="p">(</span><span class="n">func_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the functions from :py:attr:`Assignment.CONFIGURATION_FUNCTIONS_FILE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Functions are defined in here -- read this and eval it</span>
        <span class="k">if</span> <span class="n">func_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">func_file</span><span class="p">):</span>
            <span class="n">my_globals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Reading </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">func_file</span><span class="p">)</span>
            <span class="nb">execfile</span><span class="p">(</span><span class="n">func_file</span><span class="p">,</span> <span class="n">my_globals</span><span class="p">,</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">CONFIGURED_FUNCTIONS</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;PathSet.CONFIGURED_FUNCTIONS = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">CONFIGURED_FUNCTIONS</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.read_configuration"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.read_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">read_configuration</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the configuration parameters from :py:attr:`Assignment.CONFIGURATION_FILE`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">&#39;display.width&#39;</span><span class="p">,</span>      <span class="mi">1000</span><span class="p">)</span>
        <span class="c"># pandas.set_option(&#39;display.height&#39;,   1000)</span>
        <span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">&#39;display.max_rows&#39;</span><span class="p">,</span>   <span class="mi">1000</span><span class="p">)</span>
        <span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">(</span>
            <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;max_iterations&#39;</span>                  <span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s">&#39;simulation&#39;</span>                      <span class="p">:</span><span class="s">&#39;True&#39;</span><span class="p">,</span>
                      <span class="s">&#39;output_pathset_per_sim_iter&#39;</span>     <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;output_passenger_trajectories&#39;</span>   <span class="p">:</span><span class="s">&#39;True&#39;</span><span class="p">,</span>
                      <span class="s">&#39;create_skims&#39;</span>                    <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;skim_start_time&#39;</span>                 <span class="p">:</span><span class="s">&#39;5:00&#39;</span><span class="p">,</span>
                      <span class="s">&#39;skim_end_time&#39;</span>                   <span class="p">:</span><span class="s">&#39;10:00&#39;</span><span class="p">,</span>
                      <span class="s">&#39;capacity_constraint&#39;</span>             <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;skip_person_ids&#39;</span>                 <span class="p">:</span><span class="s">&#39;None&#39;</span><span class="p">,</span>
                      <span class="s">&#39;trace_ids&#39;</span>                       <span class="p">:[],</span>
                      <span class="s">&#39;debug_trace_only&#39;</span>                <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;debug_num_trips&#39;</span>                 <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s">&#39;debug_output_columns&#39;</span>            <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;fare_zone_symmetry&#39;</span>              <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;prepend_route_id_to_trip_id&#39;</span>     <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;number_of_processes&#39;</span>             <span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                      <span class="s">&#39;bump_buffer&#39;</span>                     <span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                      <span class="s">&#39;bump_one_at_a_time&#39;</span>              <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="c"># pathfinding</span>
                      <span class="s">&#39;max_num_paths&#39;</span>                   <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s">&#39;min_path_probability&#39;</span>            <span class="p">:</span><span class="mf">0.005</span><span class="p">,</span>
                      <span class="s">&#39;min_transfer_penalty&#39;</span>            <span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="s">&#39;overlap_chunk_size&#39;</span>              <span class="p">:</span><span class="mi">500</span><span class="p">,</span>
                      <span class="s">&#39;overlap_scale_parameter&#39;</span>         <span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="s">&#39;overlap_split_transit&#39;</span>           <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;overlap_variable&#39;</span>                <span class="p">:</span><span class="s">&#39;count&#39;</span><span class="p">,</span>
                      <span class="s">&#39;pathfinding_type&#39;</span>                <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span>
                      <span class="s">&#39;pathweights_fixed_width&#39;</span>         <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;stochastic_dispersion&#39;</span>           <span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="s">&#39;stochastic_max_stop_process_count&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s">&#39;stochastic_pathset_size&#39;</span>         <span class="p">:</span><span class="mi">1000</span><span class="p">,</span>
                      <span class="s">&#39;time_window&#39;</span>                     <span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                      <span class="s">&#39;transfer_fare_ignore_pathfinding&#39;</span><span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;transfer_fare_ignore_pathenum&#39;</span>   <span class="p">:</span><span class="s">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s">&#39;user_class_function&#39;</span>             <span class="p">:</span><span class="s">&#39;generic_user_class&#39;</span>
                     <span class="p">})</span>
        <span class="c"># Read configuration from specified configuration directory</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Reading configuration file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">config_fullpath</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">)</span>
		
        <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_ITERATIONS</span>                <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;max_iterations&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION</span>                    <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;simulation&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;output_passenger_trajectories&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span>   <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;output_pathset_per_sim_iter&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">CREATE_SKIMS</span>                  <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;create_skims&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_START_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                                   <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;skim_start_time&#39;</span><span class="p">),</span><span class="s">&#39;%H:%M&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_END_TIME</span>   <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                                   <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;skim_end_time&#39;</span><span class="p">),</span><span class="s">&#39;%H:%M&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span>           <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;capacity_constraint&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span>               <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;skip_person_ids&#39;</span><span class="p">))</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span>                     <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;trace_ids&#39;</span><span class="p">))</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;debug_trace_only&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span>               <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;debug_num_trips&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span>          <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;debug_output_columns&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">FARE_ZONE_SYMMETRY</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;fare_zone_symmetry&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span>   <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;prepend_route_id_to_trip_id&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span>           <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;number_of_processes&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_BUFFER</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                         <span class="n">minutes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;bump_buffer&#39;</span><span class="p">))</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;bump_one_at_a_time&#39;</span><span class="p">)</span>

        <span class="c"># pathfinding</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_NUM_PATHS</span>                 <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;max_num_paths&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">MIN_PATH_PROBABILITY</span>          <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;min_path_probability&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">MIN_TRANSFER_PENALTY</span>             <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;min_transfer_penalty&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_CHUNK_SIZE</span>               <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_chunk_size&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SCALE_PARAMETER</span>          <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_scale_parameter&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SPLIT_TRANSIT</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_split_transit&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span>                 <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_variable&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;pathfinding_type&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_FIXED_WIDTH</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;pathweights_fixed_width&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;stochastic_dispersion&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span>  <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;stochastic_max_stop_process_count&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_PATHSET_SIZE</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;stochastic_pathset_size&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">TIME_WINDOW</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                         <span class="n">minutes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;time_window&#39;</span><span class="p">))</span>

        <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;transfer_fare_ignore_pathfinding&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span>    <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;transfer_fare_ignore_pathenum&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span>                 <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;user_class_function&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span> \
                                               <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_DETERMINISTIC</span><span class="p">,</span> \
                                               <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_READ_FILE</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;pathfinding type [</span><span class="si">%s</span><span class="s">] not available. Expected values: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_DETERMINISTIC</span><span class="p">,</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_READ_FILE</span><span class="p">]))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE_OPTIONS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;pathfinding.overlap_variable [</span><span class="si">%s</span><span class="s">] not defined. Expected values: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE_OPTIONS</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">CONFIGURED_FUNCTIONS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;User class function [</span><span class="si">%s</span><span class="s">] not defined.  Please check your function file [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.read_weights"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.read_weights">[docs]</a>    <span class="k">def</span> <span class="nf">read_weights</span><span class="p">(</span><span class="n">weights_file</span> <span class="o">=</span> <span class="n">INPUT_WEIGHTS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the weights from :py:attr:`Assignment.INPUT_WEIGHTS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weights_file</span><span class="p">):</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s">&quot;No path weights file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">weights_file</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_FIXED_WIDTH</span><span class="p">:</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">weights_file</span><span class="p">)</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">weights_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">:</span><span class="nb">object</span><span class="p">},</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Weights =</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Weight types = </span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        

            </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.write_configuration"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.write_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">write_configuration</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the configuration parameters to function as a record with the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">SafeConfigParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;input_demand_dir&#39;</span><span class="p">,</span>              <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_DEMAND_DIR</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;input_network_dir&#39;</span><span class="p">,</span>             <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_NETWORK_DIR</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;input_weights&#39;</span><span class="p">,</span>                 <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_WEIGHTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;input_functions&#39;</span><span class="p">,</span>           <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;run_config&#39;</span><span class="p">,</span>                    <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FILE</span><span class="p">)</span>


        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;max_iterations&#39;</span><span class="p">,</span>                <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_ITERATIONS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;simulation&#39;</span><span class="p">,</span>                    <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;output_dir&#39;</span><span class="p">,</span>                    <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;output_passenger_trajectories&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;output_pathset_per_sim_iter&#39;</span><span class="p">,</span>   <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;create_skims&#39;</span><span class="p">,</span>                  <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CREATE_SKIMS</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;skim_start_time&#39;</span><span class="p">,</span>               <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_START_TIME</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%H:%M&#39;</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;skim_end_time&#39;</span><span class="p">,</span>                 <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_END_TIME</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%H:%M&#39;</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;capacity_constraint&#39;</span><span class="p">,</span>           <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;skip_person_ids&#39;</span><span class="p">,</span>               <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;trace_ids&#39;</span><span class="p">,</span>                     <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;debug_trace_only&#39;</span><span class="p">,</span>              <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;debug_num_trips&#39;</span><span class="p">,</span>               <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;debug_output_columns&#39;</span><span class="p">,</span>          <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;fare_zone_symmetry&#39;</span><span class="p">,</span>            <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">FARE_ZONE_SYMMETRY</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;prepend_route_id_to_trip_id&#39;</span><span class="p">,</span>   <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;number_of_processes&#39;</span><span class="p">,</span>           <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;bump_buffer&#39;</span><span class="p">,</span>                   <span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_BUFFER</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s">&#39;bump_one_at_a_time&#39;</span><span class="p">,</span>            <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>

        <span class="c">#pathfinding</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;max_num_paths&#39;</span><span class="p">,</span>               <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_NUM_PATHS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;min_path_probability&#39;</span><span class="p">,</span>        <span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MIN_PATH_PROBABILITY</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;min_transfer_penalty&#39;</span><span class="p">,</span>        <span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">MIN_TRANSFER_PENALTY</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_chunk_size&#39;</span><span class="p">,</span>          <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_CHUNK_SIZE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_scale_parameter&#39;</span><span class="p">,</span>     <span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SCALE_PARAMETER</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_split_transit&#39;</span><span class="p">,</span>       <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SPLIT_TRANSIT</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;overlap_variable&#39;</span><span class="p">,</span>            <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;pathfinding_type&#39;</span><span class="p">,</span>            <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;pathweights_fixed_width&#39;</span><span class="p">,</span>     <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_FIXED_WIDTH</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;stochastic_dispersion&#39;</span><span class="p">,</span>       <span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;stochastic_max_stop_process_count&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;stochastic_pathset_size&#39;</span><span class="p">,</span>     <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_PATHSET_SIZE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;time_window&#39;</span><span class="p">,</span>                 <span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TIME_WINDOW</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;transfer_fare_ignore_pathfinding&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;transfer_fare_ignore_pathenum&#39;</span><span class="p">,</span>    <span class="s">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span> <span class="k">else</span> <span class="s">&#39;False&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s">&#39;user_class_function&#39;</span><span class="p">,</span>         <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span><span class="p">)</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_OUTPUT_FILE</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.initialize_fasttrips_extension"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.initialize_fasttrips_extension">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_fasttrips_extension</span><span class="p">(</span><span class="n">process_number</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">stop_times_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the C++ fasttrips extension by passing it the network supply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initializing fasttrips extension for process number </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">process_number</span><span class="p">)</span>

        <span class="c"># this may not be set yet if it is iter1</span>
        <span class="n">overcap_col</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MSA_RESULTS</span><span class="p">:</span>
            <span class="n">overcap_col</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_MSA_OVERCAP</span>

        <span class="k">if</span> <span class="n">overcap_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stop_times_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">stop_times_df</span><span class="p">[</span><span class="n">overcap_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;initialize_fasttrips_extension() overcap sum: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stop_times_df</span><span class="p">[</span><span class="n">overcap_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;initialize_fasttrips_extension() STOPTIMES_COLUMN_DEPARTURE_TIME_MIN len: </span><span class="si">%d</span><span class="s"> mean: </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> \
                              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stop_times_df</span><span class="p">),</span> <span class="n">stop_times_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">initialize_supply</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">process_number</span><span class="p">,</span>
                                     <span class="n">stop_times_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                                     <span class="n">stop_times_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME_MIN</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_SHAPE_DIST_TRAVELED</span><span class="p">,</span>
                                                    <span class="n">overcap_col</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">))</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">initialize_parameters</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TIME_WINDOW</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_BUFFER</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_PATHSET_SIZE</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span><span class="p">,</span>
                                         <span class="mi">1</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="mi">1</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_NUM_PATHS</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">MIN_PATH_PROBABILITY</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.set_fasttrips_bump_wait"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.set_fasttrips_bump_wait">[docs]</a>    <span class="k">def</span> <span class="nf">set_fasttrips_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the bump wait information to the fasttrips extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># send a clear message?</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">set_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                                 <span class="n">bump_wait_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME_MIN</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">))</span></div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.write_vehicle_trips"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.write_vehicle_trips">[docs]</a>    <span class="k">def</span> <span class="nf">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;iteration&quot;</span><span class="p">,</span>                             <span class="c"># we&#39;ll add</span>
                   <span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_DIRECTION_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_SERVICE_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_ROUTE_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME_MIN</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRAVEL_TIME_SEC</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DWELL_TIME_SEC</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_STANDEES</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_FRICTION</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">,</span>
                   <span class="c"># Trip.SIM_COL_VEH_MSA_BOARDS,</span>
                   <span class="c"># Trip.SIM_COL_VEH_MSA_ALIGHTS,</span>
                   <span class="c"># Trip.SIM_COL_VEH_MSA_ONBOARD,</span>
                   <span class="c"># Trip.SIM_COL_VEH_MSA_STANDEES,</span>
                   <span class="c"># Trip.SIM_COL_VEH_MSA_FRICTION,</span>
                   <span class="c"># Trip.SIM_COL_VEH_MSA_OVERCAP</span>
                   <span class="p">]</span>

        <span class="c"># these may not be in there since they&#39;re optional</span>
        <span class="k">for</span> <span class="n">optional_col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_DIRECTION_ID</span><span class="p">,</span>
                             <span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">optional_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">optional_col</span><span class="p">)</span>

        <span class="n">veh_trips_df</span><span class="p">[</span>            <span class="s">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">veh_trips_df</span><span class="p">[</span><span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfinding_iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="s">&quot;veh_trips_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;veh_trips.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;iteration&quot;</span><span class="p">,</span><span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.merge_pathsets"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.merge_pathsets">[docs]</a>    <span class="k">def</span> <span class="nf">merge_pathsets</span><span class="p">(</span><span class="n">pathfind_trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge the given new pathset paths and links into the existing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets():     pathset_paths_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span>    <span class="n">pathset_paths_df</span><span class="p">),</span>     <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets(): new_pathset_paths_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">),</span> <span class="n">new_pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets() dtypes=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets():     pathset_links_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span>    <span class="n">pathset_links_df</span><span class="p">),</span>     <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets(): new_pathset_links_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pathset_links_df</span><span class="p">),</span> <span class="n">new_pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets() dtypes=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>


        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets():     pathfind_trip_list_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span>    <span class="n">pathfind_trip_list_df</span><span class="p">),</span>     <span class="n">pathfind_trip_list_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="c"># TODO: This might be inefficient...</span>

        <span class="c"># filter out the new pathset person trips from pathset_paths_df</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_paths_df</span><span class="p">,</span>
                                        <span class="n">right</span>    <span class="o">=</span><span class="n">pathfind_trip_list_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">]],</span>
                                        <span class="n">how</span>      <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">indicator</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_paths_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;left_only&quot;</span><span class="p">]</span>
        <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Filtered to </span><span class="si">%d</span><span class="s"> pathset_paths_df rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">))</span>
        <span class="c"># TODO: error prone, make this cleaner with where it&#39;s initialized elsewhere</span>
        <span class="n">new_pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">),</span>
                                                                                  <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">new_pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># append</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Concatenated so pathset_paths_df has </span><span class="si">%d</span><span class="s"> rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">))</span>

        <span class="c"># filter out the new pathset person trips from pathset_links_df</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                        <span class="n">right</span>    <span class="o">=</span><span class="n">pathfind_trip_list_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">]],</span>
                                        <span class="n">how</span>      <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">indicator</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;left_only&quot;</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Filtered to </span><span class="si">%d</span><span class="s"> pathset_links_df rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">))</span>
        <span class="c"># append</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Concatenated so pathset_links_df has </span><span class="si">%d</span><span class="s"> rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">))</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets():     pathset_paths_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">tail=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">),</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;merge_pathsets():     pathset_links_df len=</span><span class="si">%d</span><span class="s"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">tail=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="c"># done with this</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.number_of_pathsets"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.number_of_pathsets">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_pathsets</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of passenger trips with pathsets and returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">]))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.assign_paths"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.assign_paths">[docs]</a>    <span class="k">def</span> <span class="nf">assign_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the paths for the passengers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># write the initial load profile, iteration 0</span>
        <span class="n">veh_trips_df</span>     <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">get_full_trips</span><span class="p">()</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># write 0-iter vehicle trips</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_ITERATIONS</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="c">#: todo make max_pathfinding_iterations configurable?</span>
            <span class="k">for</span> <span class="n">pathfinding_iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>

                <span class="c"># First pathfinding_iteration, find paths for everyone</span>
                <span class="k">if</span> <span class="n">pathfinding_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># Subsequent: just find paths for those without paths</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s"> PATHFINDING ITERATION </span><span class="si">%d</span><span class="s"> **************************************&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span> <span class="o">==</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_READ_FILE</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pathfinding_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Reading paths from file&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">read_passenger_pathsets</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">modes_df</span><span class="p">,</span> <span class="n">include_asgn</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">num_new_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">number_of_pathsets</span><span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">)</span>

                    <span class="c"># todo: what about subsequent iterations</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_new_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">generate_pathsets</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">setup_passenger_pathsets</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span>
                                                                                                          <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">trip_id_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">trips_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">modes_df</span><span class="p">,</span>
                                                                                                          <span class="n">FT</span><span class="o">.</span><span class="n">transfers</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">tazs</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span><span class="p">)</span>
                    <span class="c"># write pathfinding results to special PF results file</span>
                    <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                                          <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                                          <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

                    <span class="c"># write performance info right away in case we crash, quit, etc</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="p">((</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)))</span>

                <span class="c"># If we found paths for everyone, excellent</span>
                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span><span class="p">:</span>
                    <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">new_pathset_paths_df</span>
                    <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">new_pathset_links_df</span>
                <span class="c"># Otherwise, merge with those for whom we already have</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">merge_pathsets</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">)</span>

                <span class="c"># if we have new paths, simulate them</span>
                <span class="k">if</span> <span class="n">num_new_paths_found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s"> PATHFINDING ITERATION </span><span class="si">%d</span><span class="s"> *** SIMULATING ***********************&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">))</span>
                        <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span> <span class="o">=</span> \
                            <span class="n">Assignment</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># if we&#39;re not simulating, we can still calculate costs and choose paths</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s"> PATHFINDING ITERATION </span><span class="si">%d</span><span class="s"> *****CHOOSING PATHS WITHOUT SIMULATING&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">))</span>

                        <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> \
                            <span class="n">Assignment</span><span class="o">.</span><span class="n">choose_paths_without_simulation</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

                <span class="c"># Set new schedule</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">stop_times_df</span> <span class="o">=</span> <span class="n">veh_trips_df</span>

                <span class="n">Assignment</span><span class="o">.</span><span class="n">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span><span class="p">:</span>
                    <span class="n">PathSet</span><span class="o">.</span><span class="n">write_path_times</span><span class="p">(</span><span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">output_dir</span><span class="p">)</span>

                <span class="c"># capacity gap stuff</span>
                <span class="n">num_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">number_of_pathsets</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>
                <span class="n">num_bumped_passengers</span> <span class="o">=</span> <span class="n">num_paths_found</span> <span class="o">-</span> <span class="n">num_passengers_arrived</span>
                <span class="k">if</span> <span class="n">num_paths_found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">capacity_gap</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">num_bumped_passengers</span><span class="o">/</span><span class="n">num_paths_found</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">capacity_gap</span> <span class="o">=</span> <span class="mi">100</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Length of trip list:       </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">))</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Number of pathsets found:  </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_paths_found</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  ARRIVED PASSENGERS:        </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_passengers_arrived</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  MISSED PASSENGERS:         </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_bumped_passengers</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  CAPACITY GAP:              </span><span class="si">%10.5f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">capacity_gap</span><span class="p">)</span>

                <span class="c"># if no new paths found, pathfinding_iteration loop is done</span>
                <span class="k">if</span> <span class="n">num_new_paths_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c"># end condition for iterations loop</span>
            <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">capacity_gap</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="c"># end for loop</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;capacity_gap&quot;</span><span class="p">:</span> <span class="n">capacity_gap</span><span class="p">,</span>
                <span class="s">&quot;paths_found&quot;</span><span class="p">:</span> <span class="n">num_paths_found</span><span class="p">,</span>
                <span class="s">&quot;passengers_arrived&quot;</span><span class="p">:</span> <span class="n">num_passengers_arrived</span><span class="p">,</span>
                <span class="s">&quot;passengers_missed&quot;</span><span class="p">:</span> <span class="n">num_bumped_passengers</span><span class="p">,</span>
                <span class="s">&quot;passengers_demand&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span> <span class="p">}</span>
        </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.filter_trip_list_to_not_arrived"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.filter_trip_list_to_not_arrived">[docs]</a>    <span class="k">def</span> <span class="nf">filter_trip_list_to_not_arrived</span><span class="p">(</span><span class="n">trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter the given trip list to only those that have not arrived according to *pathset_paths_df*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;filter_trip_list_to_not_arrived(): trip_list_df len=</span><span class="si">%d</span><span class="s"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_list_df</span><span class="p">),</span> <span class="n">trip_list_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;filter_trip_list_to_not_arrived(): pathset_paths_df len=</span><span class="si">%d</span><span class="s"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">),</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;pathset_paths_df.dtypes&quot;</span><span class="p">)</span>

        <span class="c"># filter to only the chosen paths</span>
        <span class="n">chosen_paths_df</span> <span class="o">=</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">,</span>
                                                <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]]</span>

        <span class="c"># add chosen index</span>
        <span class="n">trip_list_df_to_return</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="n">trip_list_df</span><span class="p">,</span>
                                              <span class="n">right</span> <span class="o">=</span><span class="n">chosen_paths_df</span><span class="p">,</span>
                                              <span class="n">how</span>   <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">)</span>
        <span class="c"># use it to filter to null chosen</span>
        <span class="n">trip_list_df_to_return</span> <span class="o">=</span> <span class="n">trip_list_df_to_return</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trip_list_df_to_return</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">])]</span>
        <span class="c"># remove chosen column</span>
        <span class="n">trip_list_df_to_return</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;filter_trip_list_to_not_arrived(): trip_list_df_to_return len=</span><span class="si">%d</span><span class="s"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_list_df_to_return</span><span class="p">),</span> <span class="n">trip_list_df_to_return</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">trip_list_df_to_return</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.generate_pathsets"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.generate_pathsets">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pathsets</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figures out which person trips for whom to generate_pathsets, stored in :py:attr:`Passenger.pathfind_trip_list_df`</span>

<span class="sd">        Generates paths sets for those person trips using deterministic trip-based shortest path (TBSP) or</span>
<span class="sd">        stochastic trip-based hyperpath (TBHP).</span>

<span class="sd">        Returns the number of pathsets found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;**************************** GENERATING PATHS **********************************************************&quot;</span><span class="p">)</span>
        <span class="n">start_time</span>          <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">process_dict</span>        <span class="o">=</span> <span class="p">{}</span>  <span class="c"># workernum -&gt; {&quot;process&quot;:process, &quot;alive&quot;:alive bool, &quot;done&quot;:done bool, &quot;working_on&quot;:(person_id, trip_list_num)}</span>
        <span class="n">todo_queue</span>          <span class="o">=</span> <span class="bp">None</span>
        <span class="n">done_queue</span>          <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># We only need to do this once</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pathfinding_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span><span class="p">:</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span><span class="o">==</span><span class="bp">True</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">:</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Truncating trip list to </span><span class="si">%d</span><span class="s"> trips&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">)</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">]</span>

            <span class="c"># Skip someone?</span>
            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span><span class="p">)]</span>

        <span class="c"># these are the trips for which we&#39;ll find paths</span>
        <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span>

        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span><span class="p">:</span>
            <span class="c"># we&#39;re starting over with empty vehicles</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">reset_onboard</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Finding paths for trips for those that haven&#39;t arrived yet&quot;</span><span class="p">)</span>
            <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">filter_trip_list_to_not_arrived</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">)</span>

        <span class="n">est_paths_to_find</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Finding pathsets for </span><span class="si">%d</span><span class="s"> trips&quot;</span> <span class="o">%</span> <span class="n">est_paths_to_find</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">est_paths_to_find</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">info_freq</span>           <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_paths_to_find</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">info_freq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">info_freq</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c"># info_freq = 1 # DEBUG CRASH</span>

        <span class="n">num_processes</span>       <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span>
        <span class="k">if</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_processes</span>   <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="c"># it&#39;s not worth it unless each process does 3</span>
        <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="n">est_paths_to_find</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">num_processes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">est_paths_to_find</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

        <span class="c"># this is probalby time consuming... put in a try block</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Setup multiprocessing processes</span>
            <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">todo_queue</span>      <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="n">done_queue</span>      <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">num_processes</span><span class="p">):</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting worker process </span><span class="si">%2d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">process_idx</span><span class="p">)</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&quot;process&quot;</span><span class="p">:</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">find_trip_based_paths_process_worker</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">process_idx</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_NETWORK_DIR</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_DEMAND_DIR</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FILE</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="n">todo_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)),</span>
                        <span class="s">&quot;alive&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                        <span class="s">&quot;done&quot;</span><span class="p">:</span><span class="bp">False</span>
                    <span class="p">}</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;process&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">initialize_fasttrips_extension</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c"># process tasks or send tasks to workers for processing</span>
            <span class="n">num_paths_found_prev</span>  <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_paths_found_now</span>   <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_paths_sought</span>      <span class="o">=</span> <span class="mi">0</span>
            <span class="n">path_cols</span>             <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path_tuple</span> <span class="ow">in</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="n">path_dict</span>         <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">path_cols</span><span class="p">,</span> <span class="n">path_tuple</span><span class="p">))</span>
                <span class="n">trip_list_id</span>      <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">]</span>
                <span class="n">person_id</span>         <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">]</span>
                <span class="n">person_trip_id</span>    <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">]</span>
                <span class="n">do_trace</span>          <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_trace</span><span class="p">:</span> <span class="k">continue</span>

                <span class="c"># first iteration -- create path objects</span>
                <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">trip_pathset</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">path_dict</span><span class="p">)</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">add_pathset</span><span class="p">(</span><span class="n">trip_list_id</span><span class="p">,</span> <span class="n">trip_pathset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trip_pathset</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">get_pathset</span><span class="p">(</span><span class="n">trip_list_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">trip_pathset</span><span class="o">.</span><span class="n">goes_somewhere</span><span class="p">():</span> <span class="k">continue</span>

                <span class="c"># find pathsets for everyone -- dwell times have changed</span>
                <span class="c"># if iteration &gt; 1 and trip_list_id not in Assignment.bumped_trip_list_nums:</span>
                <span class="c">#    num_paths_found_prev += 1</span>
                <span class="c">#    continue</span>

                <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">todo_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="n">trip_pathset</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">do_trace</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Tracing assignment of person_id </span><span class="si">%s</span><span class="s"> and trip </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">person_trip_id</span><span class="p">))</span>

                    <span class="c"># do the work</span>
                    <span class="p">(</span><span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span> <span class="o">=</span> \
                        <span class="n">Assignment</span><span class="o">.</span><span class="n">find_trip_based_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">trip_pathset</span><span class="p">,</span>
                                                           <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span>
                                                           <span class="n">trace</span><span class="o">=</span><span class="n">do_trace</span><span class="p">)</span>
                    <span class="n">num_paths_sought</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">trip_pathset</span><span class="o">.</span><span class="n">pathdict</span> <span class="o">=</span> <span class="n">pathdict</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">person_trip_id</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">trip_pathset</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>
                        <span class="n">num_paths_found_now</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">num_paths_sought</span> <span class="o">%</span> <span class="n">info_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%6d</span><span class="s"> paths sought, </span><span class="si">%6d</span><span class="s"> paths found of </span><span class="si">%d</span><span class="s"> paths total.  Time elapsed: </span><span class="si">%2d</span><span class="s">h:</span><span class="si">%2d</span><span class="s">m:</span><span class="si">%2d</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                             <span class="n">num_paths_sought</span><span class="p">,</span> <span class="n">num_paths_found_now</span><span class="p">,</span> <span class="n">est_paths_to_find</span><span class="p">,</span>
                                             <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                             <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                             <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

            <span class="c"># multiprocessing follow-up</span>
            <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># we&#39;re done, let each process know</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">todo_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;DONE&#39;</span><span class="p">)</span>

                <span class="c"># get results</span>
                <span class="n">done_procs</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># where done means not alive</span>
                <span class="k">while</span> <span class="n">done_procs</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_dict</span><span class="p">):</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span>     <span class="o">=</span> <span class="n">done_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                        <span class="n">worker_num</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c"># FastTripsLogger.debug(&quot;Received %s&quot; % str(result))</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;DONE&quot;</span><span class="p">:</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received done from process </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">worker_num</span><span class="p">)</span>
                            <span class="n">process_dict</span><span class="p">[</span><span class="n">worker_num</span><span class="p">][</span><span class="s">&quot;done&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;STARTING&quot;</span><span class="p">:</span>
                            <span class="n">process_dict</span><span class="p">[</span><span class="n">worker_num</span><span class="p">][</span><span class="s">&quot;working_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;COMPLETED&quot;</span><span class="p">:</span>
                            <span class="n">trip_list_id</span>    <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">pathset</span>         <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">get_pathset</span><span class="p">(</span><span class="n">trip_list_id</span><span class="p">)</span>
                            <span class="n">pathset</span><span class="o">.</span><span class="n">pathdict</span><span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="n">perf_dict</span>       <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                            <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span>

                            <span class="n">num_paths_sought</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">pathset</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>
                                <span class="n">num_paths_found_now</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="k">if</span> <span class="n">num_paths_sought</span> <span class="o">%</span> <span class="n">info_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  </span><span class="si">%6d</span><span class="s"> paths sought, </span><span class="si">%6d</span><span class="s"> paths found of </span><span class="si">%d</span><span class="s"> paths total.  Time elapsed: </span><span class="si">%2d</span><span class="s">h:</span><span class="si">%2d</span><span class="s">m:</span><span class="si">%2d</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                                     <span class="n">num_paths_sought</span><span class="p">,</span> <span class="n">num_paths_found_now</span><span class="p">,</span> <span class="n">est_paths_to_find</span><span class="p">,</span>
                                                     <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                                     <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                                     <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

                            <span class="k">del</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">worker_num</span><span class="p">][</span><span class="s">&quot;working_on&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;Unexpected done queue contents: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                    <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="c"># This is normal</span>
                        <span class="k">pass</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Caught exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
                        <span class="k">pass</span>

                    <span class="c"># check if any processes are not alive</span>
                    <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;alive&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;process&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Process </span><span class="si">%d</span><span class="s"> is not alive&quot;</span> <span class="o">%</span> <span class="n">process_idx</span><span class="p">)</span>
                            <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;alive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="n">done_procs</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c"># join up my processes</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;process&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="c"># check if any processes crashed</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;done&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s">&quot;working_on&quot;</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">]:</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Process </span><span class="si">%d</span><span class="s"> appears to have crashed; it was working on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                                 <span class="p">(</span><span class="n">process_idx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s">&quot;working_on&quot;</span><span class="p">])))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Process </span><span class="si">%d</span><span class="s"> appears to have crashed; see ft_debug_worker</span><span class="si">%02d</span><span class="s">.log&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">process_idx</span><span class="p">,</span> <span class="n">process_idx</span><span class="p">))</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Exception caught: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_type</span><span class="p">))</span>
            <span class="n">error_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">error_lines</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Terminating processes&quot;</span><span class="p">)</span>
            <span class="c"># terminating my processes</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># some other error</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">error_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">error_lines</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Finished finding </span><span class="si">%6d</span><span class="s"> passenger paths.  Time elapsed: </span><span class="si">%2d</span><span class="s">h:</span><span class="si">%2d</span><span class="s">m:</span><span class="si">%2d</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                 <span class="n">num_paths_found_now</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                 <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                 <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">num_paths_found_now</span> <span class="o">+</span> <span class="n">num_paths_found_prev</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.find_trip_based_pathset"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.find_trip_based_pathset">[docs]</a>    <span class="k">def</span> <span class="nf">find_trip_based_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform trip-based path set search.</span>

<span class="sd">        Will do so either backwards (destination to origin) if :py:attr:`PathSet.direction` is :py:attr:`PathSet.DIR_OUTBOUND`</span>
<span class="sd">        or forwards (origin to destination) if :py:attr:`PathSet.direction` is :py:attr:`PathSet.DIR_INBOUND`.</span>

<span class="sd">        Returns (pathdict,</span>
<span class="sd">                 performance_dict)</span>

<span class="sd">        Where pathdict maps {pathnum:{PATH_KEY_COST:cost, PATH_KEY_PROBABILITY:probability, PATH_KEY_STATES:[state list]}}</span>

<span class="sd">        Where performance_dict includes:</span>
<span class="sd">                 pathfinding return status,</span>
<span class="sd">                 number of label iterations,</span>
<span class="sd">                 max number of times a stop was processed,</span>
<span class="sd">                 seconds spent in labeling,</span>
<span class="sd">                 seconds spend in enumeration</span>

<span class="sd">        :param pathset:   the path to fill in</span>
<span class="sd">        :type  pathset:   a :py:class:`PathSet` instance</span>
<span class="sd">        :param hyperpath: pass True to use a stochastic hyperpath-finding algorithm, otherwise a deterministic shortest path</span>
<span class="sd">                          search algorithm will be use.</span>
<span class="sd">        :type  hyperpath: bool</span>
<span class="sd">        :param trace:     pass True if this path should be traced to the debug log</span>
<span class="sd">        :type  trace:     bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># FastTripsLogger.debug(&quot;C++ extension start&quot;)</span>
        <span class="c"># send it to the C++ extension</span>
        <span class="p">(</span><span class="n">ret_ints</span><span class="p">,</span> <span class="n">ret_doubles</span><span class="p">,</span> <span class="n">path_costs</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="n">pf_returnstatus</span><span class="p">,</span>
         <span class="n">label_iterations</span><span class="p">,</span> <span class="n">num_labeled_stops</span><span class="p">,</span> <span class="n">max_label_process_count</span><span class="p">,</span>
         <span class="n">ms_labeling</span><span class="p">,</span> <span class="n">ms_enumerating</span><span class="p">,</span>
         <span class="n">bytes_workingset</span><span class="p">,</span> <span class="n">bytes_privateusage</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">_fasttrips</span><span class="o">.</span><span class="n">find_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">,</span>
                                 <span class="n">pathset</span><span class="o">.</span><span class="n">user_class</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">purpose</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">access_mode</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">transit_mode</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">egress_mode</span><span class="p">,</span>
                                 <span class="n">pathset</span><span class="o">.</span><span class="n">o_taz_num</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">d_taz_num</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="k">if</span> <span class="n">pathset</span><span class="o">.</span><span class="n">outbound</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">pref_time_min</span><span class="p">),</span> <span class="n">pathset</span><span class="o">.</span><span class="n">vot</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="k">if</span> <span class="n">trace</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># FastTripsLogger.debug(&quot;C++ extension complete&quot;)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Finished finding path for person </span><span class="si">%s</span><span class="s"> trip </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">))</span>
        <span class="n">pathdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">row_num</span>  <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">path_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">path_costs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_COST</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_FARE</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_PROBABILITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_INIT_COST</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_INIT_FARE</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
            <span class="c"># List of (stop_id, stop_state)</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_STATES</span>     <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># print &quot;path_num %d&quot; % path_num</span>

            <span class="c"># while we have unprocessed rows and the row is still relevant for this path_num</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">row_num</span> <span class="o">&lt;</span> <span class="n">ret_ints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">path_num</span><span class="p">):</span>
                <span class="c"># print row_num</span>

                <span class="n">mode</span> <span class="o">=</span> <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="c"># todo</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">101</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_EGRESS</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">102</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRANSFER</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">103</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">MODE_GENERIC_TRANSIT_NUM</span>

                <span class="k">if</span> <span class="n">hyperpath</span><span class="p">:</span>
                    <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_STATES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>                                                          <span class="c"># label,</span>
                        <span class="n">Util</span><span class="o">.</span><span class="n">SIMULATION_DAY_START</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>  <span class="c"># departure/arrival time</span>
                        <span class="n">mode</span><span class="p">,</span>                                                                            <span class="c"># departure/arrival mode</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                             <span class="c"># trip id</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                                             <span class="c"># successor/predecessor</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                             <span class="c"># sequence</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>                                                             <span class="c"># sequence succ/pred</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>                              <span class="c"># link time</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                          <span class="c"># link fare</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                                          <span class="c"># link cost</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                          <span class="c"># link distance</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>                                                          <span class="c"># cost</span>
                        <span class="n">Util</span><span class="o">.</span><span class="n">SIMULATION_DAY_START</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>   <span class="c"># arrival/departure time</span>
                    <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_STATES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span>                              <span class="c"># label,</span>
                        <span class="n">Util</span><span class="o">.</span><span class="n">SIMULATION_DAY_START</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>  <span class="c"># departure/arrival time</span>
                        <span class="n">mode</span><span class="p">,</span>                                                                            <span class="c"># departure/arrival mode</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                             <span class="c"># trip id</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                                             <span class="c"># successor/predecessor</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                             <span class="c"># sequence</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>                                                             <span class="c"># sequence succ/pred</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>                              <span class="c"># link time</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                          <span class="c"># link fare</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">]),</span>                              <span class="c"># link cost</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                          <span class="c"># link dist</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">]),</span>                              <span class="c"># cost</span>
                        <span class="n">Util</span><span class="o">.</span><span class="n">SIMULATION_DAY_START</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>   <span class="c"># arrival/departure time</span>
                    <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">row_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">perf_dict</span> <span class="o">=</span> <span class="p">{</span> \
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_PROCESS_NUM</span>           <span class="p">:</span> <span class="n">process_num</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_PATHFINDING_STATUS</span>    <span class="p">:</span> <span class="n">pf_returnstatus</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_LABEL_ITERATIONS</span>      <span class="p">:</span> <span class="n">label_iterations</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_NUM_LABELED_STOPS</span>     <span class="p">:</span> <span class="n">num_labeled_stops</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_MAX_STOP_PROCESS_COUNT</span><span class="p">:</span> <span class="n">max_label_process_count</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_TIME_LABELING_MS</span>      <span class="p">:</span> <span class="n">ms_labeling</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_TIME_ENUMERATING_MS</span>   <span class="p">:</span> <span class="n">ms_enumerating</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_TRACED</span>                <span class="p">:</span> <span class="n">trace</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_WORKING_SET_BYTES</span>     <span class="p">:</span> <span class="n">bytes_workingset</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_COLUMN_PRIVATE_USAGE_BYTES</span>   <span class="p">:</span> <span class="n">bytes_privateusage</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.find_passenger_vehicle_times"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.find_passenger_vehicle_times">[docs]</a>    <span class="k">def</span> <span class="nf">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a dataframe of passenger links and a dataframe of vehicle trip links, adds two new columns to the passenger links for board and alight time.</span>

<span class="sd">        - Takes the trip links of pathset_links_df (columns: person_id, trip_list_id_num, pathnum, linkmode, trip_id_num, A_id_num, B_id_num, A_seq, B_seq, pf_A_time, pf_B_time, pf_linktime, A_id, B_id, trip_id)</span>
<span class="sd">        - Joins with vehicle trips on trip id num, A_id, A_seq to add:</span>
<span class="sd">          * board time   (Assignment.SIM_COL_PAX_BOARD_TIME)</span>
<span class="sd">          * overcap      (Assignment.SIM_COL_PAX_OVERCAP)</span>
<span class="sd">          * overcap_frac (Assignment.SIM_COL_PAX_OVERCAP_FRAC)</span>
<span class="sd">        - Joins with vehicle trips on trip id num, B_id, B_seq to add:</span>
<span class="sd">          * alight time (Assignment.SIM_COL_PAX_ALIGHT_TIME)</span>

<span class="sd">        Returns the same dataframe but with four additional columns (replacing them if they&#39;re already there).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;find_passenger_vehicle_times(): input pathset_links_df len=</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span><span class="o">==</span><span class="bp">True</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># FastTripsLogger.debug(&quot;pathset_links_df:\n%s\n&quot; % pathset_links_df.head().to_string())</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;veh_trips_df:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="n">veh_trip_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">,</span>                <span class="c"># TODO: what about msa_overcap?</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">]</span>

        <span class="c"># this one may not be here -- it&#39;s only present during capacity stuff</span>
        <span class="k">if</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">veh_trip_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">)</span>

        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span>    <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
            <span class="n">right</span>   <span class="o">=</span><span class="n">veh_trips_df</span><span class="p">[</span><span class="n">veh_trip_cols</span><span class="p">],</span>
            <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                      <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                      <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
            <span class="n">how</span>     <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span>    <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
            <span class="n">right</span>   <span class="o">=</span><span class="n">veh_trips_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span><span class="p">]],</span>
            <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span><span class="s">&#39;B_id&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                      <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                      <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
            <span class="n">how</span>     <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;_A&quot;</span><span class="p">,</span><span class="s">&quot;_B&quot;</span><span class="p">))</span>

        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">,</span>   <span class="c"># transit vehicle depart time (at A) = board time for pax</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">,</span>  <span class="c"># transit vehicle arrive time (at B) = alight time for pax</span>
        <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># redundant with A_id, B_id, A_seq, B_seq, B_time is just alight time</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_A&#39;</span> <span class="o">%</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                               <span class="s">&#39;</span><span class="si">%s</span><span class="s">_B&#39;</span> <span class="o">%</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                               <span class="s">&#39;</span><span class="si">%s</span><span class="s">_A&#39;</span> <span class="o">%</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                               <span class="s">&#39;</span><span class="si">%s</span><span class="s">_B&#39;</span> <span class="o">%</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;find_passenger_vehicle_times(): output pathset_links_df len=</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span><span class="o">==</span><span class="bp">True</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">pathset_links_df</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.put_passengers_on_vehicles"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.put_passengers_on_vehicles">[docs]</a>    <span class="k">def</span> <span class="nf">put_passengers_on_vehicles</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Puts the chosen passenger trips specified in pathset_links_df onto the transit vehicle trips specified by veh_trip_df.</span>

<span class="sd">        Returns veh_trips_df but with updated columns</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_BOARDS`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_ALIGHTS`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_ONBOARD`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_OVERCAP`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_OVERCAP_FRAC`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># drop these -- we&#39;ll set them</span>
        <span class="k">if</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span>
                               <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">,</span>
                               <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">veh_trips_df_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">)</span>
        <span class="c"># only care about trips</span>
        <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>

        <span class="c"># Group to boards by counting trip_list_id_nums for a (trip_id, A_id as stop_id)</span>
        <span class="n">passenger_trips_boards</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span>  <span class="c"># unbumped passengers</span>
                                                   <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s">&#39;A_id_num&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s">&#39;A_id_num&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">passenger_trips_boards</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                              <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                              <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]</span>

        <span class="c"># And alights by counting path_ids for a (trip_id, B_id as stop_id)</span>
        <span class="n">passenger_trips_alights</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span>
                                                    <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
                                                     <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s">&#39;B_id_num&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s">&#39;B_id_num&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">passenger_trips_alights</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]</span>

        <span class="c"># Join them to the transit vehicle trips so we can put people on vehicles (boards)</span>
        <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>        <span class="o">=</span> <span class="n">veh_trips_df</span><span class="p">,</span>
                                     <span class="n">right</span>       <span class="o">=</span> <span class="n">passenger_trips_boards</span><span class="p">,</span>
                                     <span class="n">left_on</span>     <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                     <span class="n">right_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                     <span class="n">how</span>         <span class="o">=</span> <span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


        <span class="c"># Join for alights</span>
        <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>        <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">,</span>
                                     <span class="n">right</span>       <span class="o">=</span> <span class="n">passenger_trips_alights</span><span class="p">,</span>
                                    <span class="n">left_on</span>      <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                    <span class="n">right_index</span>  <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                    <span class="n">how</span>          <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="p">)</span><span class="o">==</span><span class="n">veh_trips_df_len</span><span class="p">)</span>

        <span class="c"># these are ints, not floats</span>
        <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span>    <span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span>    <span class="p">]</span> <span class="o">-</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span>    <span class="p">]</span>

        <span class="c"># on board is the cumulative sum of boards - alights</span>
        <span class="n">trips_cumsum</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># replace with cumsum</span>
        <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>        <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">,</span>
                                     <span class="n">right</span>       <span class="o">=</span> <span class="n">trips_cumsum</span><span class="p">,</span>
                                     <span class="n">left_index</span>  <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                     <span class="n">right_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                     <span class="n">how</span>         <span class="o">=</span> <span class="s">&#39;left&#39;</span><span class="p">)</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="p">)</span><span class="o">==</span><span class="n">veh_trips_df_len</span><span class="p">)</span>
        <span class="c"># print veh_trips_df.loc[5123368]</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># overcap = how many people are problematic, or onboard-totalcap.  If negative, we have space.</span>
        <span class="c"># overcap_frac = what percentage of boards are problematic</span>
        <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]</span> <span class="o">-</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">]</span>
        <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span> <span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">]</span><span class="o">/</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">]</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;veh_loaded_df with onboard&gt;0: (showing head)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> \
                              <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">veh_loaded_df</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.flag_missed_transfers"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.flag_missed_transfers">[docs]</a>    <span class="k">def</span> <span class="nf">flag_missed_transfers</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given passenger pathset links with the vehicle board_time and alight_time attached to trip links,</span>
<span class="sd">        this method will add columns to determine if there are missed transfers.</span>

<span class="sd">        This works on all paths in the pathset rather than just the chosen paths because then we can choose</span>
<span class="sd">        a path without missed transfers.</span>

<span class="sd">        The following columns are used in pathset_links_df:</span>
<span class="sd">        * Passenger.TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM,</span>
<span class="sd">        * Passenger.PF_COL_PATH_NUM,</span>
<span class="sd">        * Passenger.PF_COL_LINK_NUM,</span>
<span class="sd">        * Assignment.SIM_COL_PAX_BOARD_TIME</span>
<span class="sd">        * Assignment.SIM_COL_PAX_ALIGHT_TIME</span>
<span class="sd">        * Passenger.PF_COL_PAX_B_TIME</span>

<span class="sd">        In particular, the following columns are added (or replaced if they&#39;re already there) to *pathset_links_df*:</span>

<span class="sd">        ======================================================= ==============================================================================</span>
<span class="sd">        Column Name                                             Column Description</span>
<span class="sd">        ======================================================= ==============================================================================</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_ALIGHT_DELAY_MIN`      Delay in alight_time from original pathfinding understanding of alight time</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_A_TIME`                New A time given the trip board/alight times for the trip links</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_B_TIME`                New B time given the trip board/alight times for the trip links</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_LINK_TIME`             New link time from B time - A time</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_WAIT_TIME`             New waittime given the trip board/alight times for the trip links</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_MISSED_XFER`           Is this link a missed xfer</span>
<span class="sd">        ======================================================= ==============================================================================</span>

<span class="sd">        The column, :py:attr:`AssignmentSIM_COL_PAX_MISSED_XFER`, is also added to *pathset_paths_df*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Drop these, we&#39;ll set them again</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Set alight delay (min)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;flag_missed_transfers() pathset_links_df (</span><span class="si">%d</span><span class="s">):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID</span><span class="p">]),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">((</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span><span class="o">-</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">])</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">))</span>

        <span class="c">#: todo: is there a more elegant way to take care of this?  some trips have times after midnight so they&#39;re the next day</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">22</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">22</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">22</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">((</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span><span class="o">-</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">])</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">))</span>

        <span class="n">max_alight_delay_min</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Biggest alight_delay = </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">max_alight_delay_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_alight_delay_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="c"># For trips, alight_time is the new B_time</span>
        <span class="c"># Set A_time for links AFTER trip links by joining to next leg</span>
        <span class="n">next_trips</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">next_trips</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># Add it to passenger trips.  Now A time is set for links after trip links (note this will never be a trip link)</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span> 
                                        <span class="n">right</span><span class="o">=</span><span class="n">next_trips</span><span class="p">,</span>
                                        <span class="n">how</span>  <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">on</span>   <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">])</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="c"># Set the new B time for those links -- link time for access/egress/xfer is travel time since wait times are in trip links</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">+</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_TIME</span><span class="p">]</span>
        <span class="c"># For trip links, it&#39;s alight time</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">,</span>   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span>
        <span class="c"># For access links, it doesn&#39;t change from the original pathfinding result</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">]</span>

        <span class="c"># Now we only need to set the trip link&#39;s A time from the previous link&#39;s new_B_time</span>
        <span class="n">next_trips</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">next_trips</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">:</span><span class="s">&quot;new_trip_A_time&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># Add it to passenger trips.  Now new_trip_A_time is set for trip links</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                        <span class="n">right</span> <span class="o">=</span><span class="n">next_trips</span><span class="p">,</span>
                                        <span class="n">how</span>   <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">on</span>    <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">])</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;new_trip_A_time&quot;</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;new_trip_A_time&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>

        <span class="c">#: todo: is there a more elegant way to take care of this?  some trips have times after midnight so they&#39;re the next day</span>
        <span class="c">#: if the linktime &gt; 22 hours then the trip time is probably off by a day, so it&#39;s right after midnight -- back it up</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>

        <span class="c">#: if the linktime &lt; -22 hours then the trip time is probably off by a day, so it&#39;s right before midnight -- back it up</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>


        <span class="c"># new wait time</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID</span><span class="p">]),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>

        <span class="c"># invalid trips have negative wait time</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span><span class="p">]</span><span class="o">&lt;</span><span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># count how many are valid (sum of invalid = 0 for the trip list id + path)</span>
        <span class="n">pathset_links_df_grouped</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span> <span class="c"># sort by this</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">:</span><span class="s">&quot;sum&quot;</span> <span class="p">})</span>

        <span class="n">pathset_links_df_grouped</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df_grouped</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;          flag_missed_transfers found </span><span class="si">%d</span><span class="s"> missed transfer trip legs for </span><span class="si">%d</span><span class="s"> paths&quot;</span> <span class="o">%</span> \
                             <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                              <span class="n">pathset_links_df_grouped</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="c"># add missed_xfer to pathset_paths_df (replacing if it was there already)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="n">pathset_paths_df</span><span class="p">,</span>
                                        <span class="n">right</span> <span class="o">=</span><span class="n">pathset_links_df_grouped</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]],</span>
                                        <span class="n">how</span>   <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;flag_missed_transfers() pathset_paths_df (</span><span class="si">%d</span><span class="s">):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">),</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.load_passengers_on_vehicles_with_cap"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.load_passengers_on_vehicles_with_cap">[docs]</a>    <span class="k">def</span> <span class="nf">load_passengers_on_vehicles_with_cap</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
                                             <span class="n">trips</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if we have boards on over-capacity vehicles.  Mark them and mark the boards.</span>

<span class="sd">        If :py:attr:`Assignment.CAPACITY_CONSTRAINT`, then bump off overcapacity passengers.</span>

<span class="sd">        The process is:</span>

<span class="sd">        1) Look at which vehicle links are over capacity, adding columns named :py:attr:`Trip.SIM_COL_VEH_OVERCAP`</span>
<span class="sd">           and py:attr:`Trip.SIM_COL_VEH_OVERCAP_FRAC` to *veh_loaded_df*</span>

<span class="sd">        2) Look at the stops where the first people board after we&#39;re at capacity (impossible boards) if any</span>

<span class="sd">        3) If :py:attr:`Assignment.BUMP_ONE_AT_A_TIME`, select the first such stop by arrival time</span>
<span class="sd">           Otherwise, select the first such stop for each vehicle trip</span>

<span class="sd">        4) Join these stops to pathset_links_df, so pathset_links_df now has column Assignment.SIM_COL_PAX_OVERCAP_FRAC</span>

<span class="sd">        5) If not :py:attr:`Assignment.CAPACITY_CONSTRAINT`, return (and drop the column named :py:attr:`Trip.SIM_COL_VEH_OVERCAP` from veh_loaded_df)</span>

<span class="sd">        6) Figure out which passenger trips are actually getting bumped.  Some people can get on at these stops, but not all, so let the first</span>
<span class="sd">           ones that arrive at the stop get on and filter to the ones we&#39;ll actually bump.  Update the column named :py:attr:`Assignmment.SIM_COL_PAX_BUMP_ITER`.</span>
<span class="sd">           If non-null, this represents the iteration the passenger got bumped.</span>

<span class="sd">        Return (chosen_paths_bumped, pathset_paths_df, pathset_links_df, veh_loaded_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># these are the relevant vehicle columns</span>
        <span class="n">vehicle_trip_debug_columns</span> <span class="o">=</span> <span class="p">[</span> \
            <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_ROUTE_ID</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span>
        <span class="p">]</span>
        <span class="c"># these are the relevant pathset links colums</span>
        <span class="n">pax_links_debug_columns</span> <span class="o">=</span> <span class="p">[</span> \
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">,</span>
            <span class="s">&quot;A_id&quot;</span><span class="p">,</span><span class="s">&quot;A_id_num&quot;</span><span class="p">,</span><span class="s">&quot;A_seq&quot;</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">current_pf_iter</span>  <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">pathfinding_iteration</span> <span class="o">+</span> <span class="n">iteration</span>
        <span class="n">current_sim_iter</span> <span class="o">=</span> <span class="s">&quot;iter</span><span class="si">%.2f</span><span class="s"> sim</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_pf_iter</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">)</span>

        <span class="c"># this will involve looping</span>
        <span class="c"># no one is bumped yet</span>
        <span class="n">bump_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>

        <span class="k">if</span> <span class="n">simulation_iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c"># For those we just found paths for, no one is bumped or going on overcap vehicles yet</span>
            <span class="c"># pathset_paths_df.loc[pathset_paths_df[Passenger.PF_COL_PF_ITERATION]==current_pf_iter, Assignment.SIM_COL_PAX_BUMP_ITER   ] = numpy.NaN</span>
            <span class="c"># pathset_links_df.loc[pathset_links_df[Passenger.PF_COL_PF_ITERATION]==current_pf_iter, Assignment.SIM_COL_PAX_BUMP_ITER   ] = numpy.NaN</span>
            <span class="c"># pathset_links_df.loc[pathset_links_df[Passenger.PF_COL_PF_ITERATION]==current_pf_iter, Assignment.SIM_COL_PAX_BOARD_STATE ] = numpy.NaN</span>

            <span class="c"># anyone can be bumped, including those from previous pathfinding iters.  Otherwise, we wouldn&#39;t be able to ride to an earlier stop and bump them</span>
            <span class="n">pathset_paths_df</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">pathset_links_df</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">pathset_links_df</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>

        <span class="c"># make sure BOARD_STATE and CHOSEN are categorical</span>
        <span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BOARD_STATE_CATEGORICAL</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c"># loop for capacity constraint</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 5.1 Put passengers on transit vehicles.&quot;</span><span class="p">)</span>
            <span class="c"># Put passengers on vehicles, updating the vehicle&#39;s boards, alights, onboard, overcap, overcap_frac</span>
            <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">put_passengers_on_vehicles</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;after putting passengers on vehicles, veh_loaded_df with onboard.head(30) = </span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> 
                                  <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">vehicle_trip_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span><span class="p">:</span>
                <span class="c"># We can&#39;t do anything about capacity so assume everyone boarded</span>
                <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PF_ITERATION</span><span class="p">]</span><span class="o">==</span><span class="n">current_pf_iter</span><span class="p">)</span><span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_TRIP_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()),</span>
                                       <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;board_easy&quot;</span>
                <span class="k">break</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 5.2 Capacity constraints on transit vehicles.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bump_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;          Bumping one at a time? </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;true&quot;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span> <span class="k">else</span> <span class="s">&quot;false&quot;</span><span class="p">))</span>

            <span class="c"># This will update board time, alight time, overcap, overcap_frac</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;pathset_links_df.head(20)=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">pax_links_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="c"># make sure BOARD_STATE and CHOSEN are categorical</span>
            <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BOARD_STATE_CATEGORICAL</span><span class="p">)</span>

            <span class="c"># CHOSEN: Everyone who can board easily, do so</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>   <span class="c"># chosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">),</span>                                 <span class="c"># can board</span>
                                        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;board_easy&quot;</span>
            <span class="c"># CHOSEN:  Everyone who can squeeze in, do so</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>   <span class="c"># chosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span>                                <span class="c"># can barely board</span>
                                       <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;boarded&quot;</span>
            <span class="c"># UNCHOSEN: paths that are overcap -- nope</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>  <span class="c"># unchosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">),</span>                                <span class="c"># overcap </span>
                                        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bumped_unchosen&quot;</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>  <span class="c"># unchosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">),</span>                                <span class="c"># overcap</span>
                                        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span> <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>

            <span class="c"># For those trying to board overcap, choose the winners and losers</span>
            <span class="c"># These are trips/stops over capacity</span>
            <span class="n">overcap_df</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;load_passengers_on_vehicles_with_cap() </span><span class="si">%d</span><span class="s"> vehicle trip/stops over capacity: (showing head)</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overcap_df</span><span class="p">),</span> <span class="n">overcap_df</span><span class="p">[</span><span class="n">vehicle_trip_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

            <span class="c"># If none, we&#39;re done</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overcap_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;          No over-capacity vehicles&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c"># 2) Look at the trip-stops where the *first people* board after we&#39;re at capacity (impossible boards) if any</span>
            <span class="n">bump_stops_df</span> <span class="o">=</span> <span class="n">overcap_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;load_passengers_on_vehicles_with_cap() bump_stops_df iter=</span><span class="si">%d</span><span class="s"> pf_iter=</span><span class="si">%d</span><span class="s"> sim_iter=</span><span class="si">%d</span><span class="s"> bump_iter=</span><span class="si">%d</span><span class="s"> (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">bump_iter</span><span class="p">,</span>
                                   <span class="nb">len</span><span class="p">(</span><span class="n">bump_stops_df</span><span class="p">),</span> <span class="n">bump_stops_df</span><span class="p">[</span><span class="n">vehicle_trip_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span><span class="p">:</span>
                <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">bump_stops_df</span> <span class="o">=</span> <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;          Need to bump </span><span class="si">%d</span><span class="s"> passengers from </span><span class="si">%d</span><span class="s"> trip-stops&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bump_stops_df</span><span class="o">.</span><span class="n">overcap</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_stops_df</span><span class="p">)))</span>
            <span class="c"># debug -- see the whole trip</span>
            <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;load_passengers_on_vehicles_with_cap() Trips with bump stops:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
                    <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">left</span><span class="o">=</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">vehicle_trip_debug_columns</span><span class="p">],</span>
                        <span class="n">right</span><span class="o">=</span><span class="n">bump_stops_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">]],</span>
                        <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="c"># make sure CHOSEN is categorical</span>
            <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># join CHOSEN pathset links to bump_stops_df; now passenger links boarding at a bump stop will have Trip.STOPTIMES_COLUMN_STOP_SEQUENCE set</span>
            <span class="n">bumpstop_boards</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>    <span class="o">=</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c"># trip links only</span>
                                                                          <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c"># not already bumped</span>
                                                                          <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span> <span class="p">],</span> <span class="c"># chosen</span>
                                           <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s">&quot;A_seq&quot;</span><span class="p">],</span>
                                           <span class="n">right</span>   <span class="o">=</span><span class="n">bump_stops_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]],</span>
                                           <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                           <span class="n">how</span>     <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">)</span>
            <span class="c"># bump candidates: boarding at bump stops, chosen paths</span>
            <span class="n">bumpstop_boards</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="c"># board at bump_stops_df stop</span>
                                                   <span class="n">pax_links_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c"># bump off later arrivals, later trip_list_num</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span> \
                <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">,</span> <span class="c"># I think this is correct</span>
                <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                <span class="s">&quot;A_seq&quot;</span><span class="p">,</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">,</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">],</span>
                <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># For each trip_id, stop_seq, stop_id, we want the first *overcap* rows</span>
            <span class="c"># group to trip_id, stop_seq, stop_id and count off</span>
            <span class="n">bpb_count</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span><span class="s">&quot;A_seq&quot;</span><span class="p">,</span><span class="s">&quot;A_id_num&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
            <span class="n">bpb_count</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;bump_index&#39;</span>
            <span class="c"># Add the bump index to our passenger-paths/stops</span>
            <span class="n">bumpstop_boards</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bumpstop_boards</span><span class="p">,</span> <span class="n">bpb_count</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># bump or board them</span>
            <span class="n">bumpstop_boards</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="s">&quot;boarded&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bumpstop_boards</span><span class="p">),</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BOARD_STATE_CATEGORICAL</span><span class="p">)</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="s">&quot;bump_index&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">],</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bumped&quot;</span>  <span class="c"># these folks got bumped</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="s">&quot;bump_index&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">],</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>  <span class="c"># these folks got bumped</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;load_passengers_on_vehicles_with_cap() bumpstop_boards (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bumpstop_boards</span><span class="p">),</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

            <span class="c"># filter to unique passengers/paths who got bumped</span>
            <span class="n">bump_paths</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">==</span> <span class="s">&quot;bumped&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">chosen_paths_bumped</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_paths</span><span class="p">)</span>

            <span class="c"># figure when the wait time starts for the bump stops</span>
            <span class="n">new_bump_wait</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s">&quot;A_seq&quot;</span><span class="p">,</span> <span class="s">&quot;A_id_num&quot;</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> \
                                            <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s">&quot;A_seq&quot;</span><span class="p">,</span><span class="s">&quot;A_id_num&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;A_seq&quot;</span>   <span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                          <span class="s">&quot;A_id_num&quot;</span><span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># need trip id num</span>
            <span class="n">new_bump_wait</span> <span class="o">=</span> <span class="n">trips</span><span class="o">.</span><span class="n">add_numeric_trip_id</span><span class="p">(</span><span class="n">new_bump_wait</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;new_bump_wait (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_bump_wait</span><span class="p">),</span> <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

             <span class="c"># incorporate it into the bump wait df</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">):</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span> <span class="o">=</span> <span class="n">new_bump_wait</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">,</span> <span class="n">new_bump_wait</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;load_passengers_on_vehicles_with_cap() bump_wait_df (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                                <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># finally, incorporate the board state and bump_iter to the full pathset_links_df</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                            <span class="n">right</span>  <span class="o">=</span><span class="n">bumpstop_boards</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                                                     <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">,</span>
                                                                     <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]],</span>
                                            <span class="n">on</span>     <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                            <span class="n">how</span>    <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                            <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot; bb&quot;</span><span class="p">],</span>
                                            <span class="n">indicator</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>  <span class="p">]</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;_merge&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">pax_links_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

            <span class="c"># bump the whole path</span>
            <span class="n">bump_paths_df</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">==</span><span class="n">bump_iter</span><span class="p">,</span>
                                                 <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                  <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                  <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_paths_df</span><span class="p">,</span>
                                            <span class="n">right</span>    <span class="o">=</span><span class="n">bump_paths_df</span><span class="p">,</span>
                                            <span class="n">how</span>      <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                            <span class="n">indicator</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_paths_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span> <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># communicate back to other links in the same path too</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                            <span class="n">right</span>    <span class="o">=</span><span class="n">bump_paths_df</span><span class="p">,</span>
                                            <span class="n">how</span>      <span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span>
                                            <span class="n">indicator</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span> <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="s">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;both&quot;</span><span class="p">)</span><span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">|</span>
                                   <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;boarded&quot;</span><span class="p">)</span><span class="o">|</span>
                                   <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;board_easy&quot;</span><span class="p">))</span><span class="o">&amp;</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> 
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bumped_othertrip&quot;</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;        -&gt; completed loop bump_iter </span><span class="si">%d</span><span class="s"> and bumped </span><span class="si">%d</span><span class="s"> chosen paths&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bump_iter</span><span class="p">,</span> <span class="n">chosen_paths_bumped</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">chosen_paths_bumped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">bump_iter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME_MIN</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mf">60.0</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">minute</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">second</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bump_wait_df:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.choose_paths_without_simulation"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.choose_paths_without_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">choose_paths_without_simulation</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a pathset for each passernger, choose a path (if relevant).  That&#39;s it.</span>

<span class="sd">        Returns (valid_linked_trips, pathset_paths_df, pathset_links_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation_iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 1. Find out board/alight times for all pathset links from vehicle times&quot;</span><span class="p">)</span>

        <span class="c"># could do this just to chosen path links but let&#39;s do this to the whole pathset</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="c"># instead of flag_missed_transfers(), set these to pathfinding results</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_WAIT_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_MISSED_XFER</span>     <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 2. Calculate costs and probabilities for all pathset paths&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span>
            <span class="n">FT</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">,</span>
            <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="c">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 3. Choose a path for each passenger from their pathset&quot;</span><span class="p">)</span>

        <span class="c"># Choose path for each passenger -- pathset_paths_df and pathset_links_df will now have</span>
        <span class="c"># SIM_COL_PAX_CHOSEN &gt;=0 for chosen paths/path links</span>
        <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">num_chosen</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">choose_paths</span><span class="p">(</span>
            <span class="bp">True</span><span class="p">,</span>  <span class="c"># choose for everyone</span>
            <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
            <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

        <span class="c"># Write the pathsets</span>
        <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>

        <span class="c"># write the final chosen paths for this iteration</span>
        <span class="n">chosen_links_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="p">[</span><span class="s">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_links_df</span><span class="p">,</span> <span class="s">&quot;chosen_links_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;chosenpaths_links.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">chosen_paths_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="p">[</span><span class="s">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_paths_df</span><span class="p">,</span> <span class="s">&quot;chosen_paths_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;chosenpaths_paths.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.simulate"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a pathset for each passenger, choose a path (if relevant) and then</span>
<span class="sd">        actually assign the passengers trips to the vehicles.</span>

<span class="sd">        Returns (valid_linked_trips, pathset_paths_df, pathset_links_df, veh_loaded_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation_iteration</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_passengers_arrived</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># will get returned from choose_paths</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Simulation Iteration </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">simulation_iteration</span><span class="p">)</span>
            <span class="c"># for trace_tuple in Assignment.TRACE_PERSON_IDS:</span>
            <span class="c">#     FastTripsLogger.debug(&quot;Initial pathset_links_df for %s\n%s&quot; % \</span>
            <span class="c">#        (str(trace_pax), pathset_links_df.loc[pathset_links_df.person_id==trace_pax].to_string()))</span>
            <span class="c">#     FastTripsLogger.debug(&quot;Initial pathset_paths_df for %s\n%s&quot; % \</span>
            <span class="c">#        (str(trace_pax), pathset_paths_df.loc[pathset_paths_df.person_id==trace_pax].to_string()))</span>

            <span class="c">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 1. Find out board/alight times for all pathset links from vehicle times&quot;</span><span class="p">)</span>

            <span class="c"># could do this just to chosen path links but let&#39;s do this to the whole pathset</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 2. Flag missed transfer links and paths in the pathsets&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">flag_missed_transfers</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

            <span class="c">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 3. Calculate costs and probabilities for all pathset paths&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span>
                <span class="n">FT</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">,</span>
                <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 4. Choose a path for each passenger from their pathset&quot;</span><span class="p">)</span>

            <span class="c"># Choose path for each passenger -- pathset_paths_df and pathset_links_df will now have</span>
            <span class="c"># SIM_COL_PAX_CHOSEN &gt;=0 for chosen paths/path links</span>
            <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">num_chosen</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">choose_paths</span><span class="p">(</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span> <span class="ow">and</span> <span class="n">simulation_iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span>  <span class="c"># choose for everyone if we just re-found all paths</span>
                <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
                <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

            <span class="c">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 5. Put passenger paths on transit vehicles to get vehicle boards/alights/load and assess capacity constraints&quot;</span><span class="p">)</span>

            <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">load_passengers_on_vehicles_with_cap</span><span class="p">(</span>
                <span class="n">FT</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 6. Update dwell and travel times for transit vehicles&quot;</span><span class="p">)</span>
            <span class="c"># update the trip times -- accel/decel rates + stops affect travel times, and boards/alights affect dwell times</span>
            <span class="n">veh_trips_df</span>   <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">update_trip_times</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MSA_RESULTS</span><span class="p">)</span>

            <span class="c">######################################################################################################</span>
            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Step 8. Write pathsets (paths and links)&quot;</span><span class="p">)</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> 
                                      <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                                      <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>

            <span class="n">simulation_iteration</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">num_chosen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  No more path choices to make =&gt; Ending simulation loop&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">simulation_iteration</span> <span class="o">&gt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_SIMULATION_ITERS</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  Maximum simulation iterations reached (</span><span class="si">%d</span><span class="s">) =&gt; Ending simulation loop&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_SIMULATION_ITERS</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c"># Write the pathsets (if we haven&#39;t been already)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>

        <span class="c"># write the final chosen paths for this iteration</span>
        <span class="n">chosen_links_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="p">[</span><span class="s">&quot;iteration&quot;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">chosen_links_df</span><span class="p">[</span><span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfinding_iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_links_df</span><span class="p">,</span> <span class="s">&quot;chosen_links_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;chosenpaths_links.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">((</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;iteration&quot;</span><span class="p">,</span> <span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">chosen_paths_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="p">[</span><span class="s">&quot;iteration&quot;</span>            <span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">chosen_paths_df</span><span class="p">[</span><span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfinding_iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_paths_df</span><span class="p">,</span> <span class="s">&quot;chosen_paths_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;chosenpaths_paths.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">((</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&quot;iteration&quot;</span><span class="p">,</span> <span class="s">&quot;pathfinding_iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


        <span class="k">return</span> <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

</div></div>
<span class="k">def</span> <span class="nf">find_trip_based_paths_process_worker</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">worker_num</span><span class="p">,</span> <span class="n">input_network_dir</span><span class="p">,</span> <span class="n">input_demand_dir</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">func_file</span><span class="p">,</span>
                                         <span class="n">output_dir</span><span class="p">,</span> <span class="n">todo_pathset_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">bump_wait_df</span><span class="p">,</span> <span class="n">stop_times_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process worker function.  Processes all the paths in queue.</span>

<span class="sd">    todo_queue has (passenger_id, path object)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker_str</span> <span class="o">=</span> <span class="s">&quot;_worker</span><span class="si">%02d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">worker_num</span>

    <span class="kn">from</span> <span class="nn">.FastTrips</span> <span class="kn">import</span> <span class="n">FastTrips</span>
    <span class="n">setupLogging</span><span class="p">(</span><span class="n">infoLogFilename</span>  <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">debugLogFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FastTrips</span><span class="o">.</span><span class="n">DEBUG_LOG</span> <span class="o">%</span> <span class="n">worker_str</span><span class="p">),</span> 
                 <span class="n">logToConsole</span>     <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                 <span class="n">append</span>           <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="p">((</span><span class="n">iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="k">else</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Iteration </span><span class="si">%d</span><span class="s"> Pathfinding Iteration </span><span class="si">%d</span><span class="s"> Worker </span><span class="si">%2d</span><span class="s"> starting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">worker_num</span><span class="p">))</span>

    <span class="c"># the child process doesn&#39;t have these set so read them</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FILE</span>           <span class="o">=</span> <span class="n">run_config</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span> <span class="o">=</span> <span class="n">func_file</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">read_functions</span><span class="p">(</span><span class="n">func_file</span><span class="p">)</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">read_configuration</span><span class="p">(</span><span class="n">run_config</span><span class="p">)</span>

    <span class="c"># this passes those read parameters and the stop times to the C++ extension</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">initialize_fasttrips_extension</span><span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">stop_times_df</span><span class="p">)</span>

    <span class="c"># the extension has it now, so we&#39;re done</span>
    <span class="n">stop_times_df</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">set_fasttrips_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c"># go through my queue -- check if we&#39;re done</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="n">todo_pathset_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">todo</span> <span class="o">==</span> <span class="s">&#39;DONE&#39;</span><span class="p">:</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s">&#39;DONE&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received DONE from the todo_pathset_queue&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># do the work</span>
        <span class="n">pathset</span> <span class="o">=</span> <span class="n">todo</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Processing person </span><span class="si">%20s</span><span class="s"> trip </span><span class="si">%20s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">))</span>
        <span class="c"># communicate it to the parent</span>
        <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s">&quot;STARTING&quot;</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span> <span class="p">))</span>

        <span class="n">trace_person</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Tracing assignment of person </span><span class="si">%s</span><span class="s"> trip </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">))</span>
            <span class="n">trace_person</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_trip_based_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace_person</span><span class="p">)</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s">&quot;COMPLETED&quot;</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">trip_list_id_num</span><span class="p">,</span> <span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Exception&quot;</span><span class="p">)</span>
            <span class="c"># call it a day</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s">&quot;EXCEPTION&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2016, Lisa Zorn.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>